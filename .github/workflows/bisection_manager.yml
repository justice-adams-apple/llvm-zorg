name: Git Bisection Pipeline

on:
  workflow_dispatch:
    inputs:
      good_commit:
        description: 'Known good commit SHA'
        required: true
        type: string
      bad_commit:
        description: 'Known bad commit SHA'
        required: true
        type: string
      test_job_name:
        description: 'Job to execute for testing each commit'
        required: true
        default: 'llvm-build'
        type: string
      repository:
        description: 'Repository to bisect'
        required: true
        default: 'llvm-project'
        type: choice
        options:
          - 'llvm-project'
      session_id:
        description: 'Session ID to continue (optional)'
        required: false
        type: string
      dry_run:
        description: 'Dry run mode'
        required: false
        default: false
        type: boolean

jobs:
  bisection:
    runs-on: ubuntu-latest
    timeout-minutes: 480

    steps:
      - name: Validate Parameters
        run: |
          if [ -z "${{ inputs.good_commit }}" ] || [ -z "${{ inputs.bad_commit }}" ]; then
            echo "âŒ Both GOOD_COMMIT and BAD_COMMIT parameters are required"
            exit 1
          fi
          
          if [ -z "${{ inputs.test_job_name }}" ]; then
            echo "âŒ TEST_JOB_NAME parameter is required"
            exit 1
          fi

      - name: Checkout main repository (for shared library)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          path: zorg

      - name: Checkout LLVM project
        uses: actions/checkout@v4
        with:
          repository: llvm/llvm-project
          ref: main
          fetch-depth: 0
          path: llvm-project

      - name: Setup Repository
        run: |
          echo "ðŸ“ Setting up repository: ${{ inputs.repository }}..."
          cd ${{ inputs.repository }}
          
          # Verify commits exist
          git cat-file -e ${{ inputs.good_commit }}
          git cat-file -e ${{ inputs.bad_commit }}
          
          echo "âœ… Repository setup complete"

      - name: Setup Python and Bisection Manager
        run: |
          # Copy bisection manager from shared library
          cp zorg/resources/scripts/bisect.py ./
          chmod +x bisect.py

      - name: Initialize Bisection
        run: |
          SESSION_ARG=""
          if [ -n "${{ inputs.session_id }}" ]; then
            SESSION_ARG="--session-id ${{ inputs.session_id }}"
          fi
          
          python3 bisect.py init \
            ${{ inputs.good_commit }} \
            ${{ inputs.bad_commit }} \
            --test-job ${{ inputs.test_job_name }} \
            --repo-path ${{ inputs.repository }} \
            $SESSION_ARG > /dev/null

      - name: Execute Bisection
        run: |
          step_number=1
          max_steps=50
          
          while [ $step_number -le $max_steps ]; do
            # Log step and get info
            step_info_json=$(python3 bisect.py log-step $step_number --repo-path ${{ inputs.repository }})
            step_type=$(echo "$step_info_json" | jq -r '.type')
            
            if [ "$step_type" = "complete" ]; then
              failing_commit=$(echo "$step_info_json" | jq -r '.failing_commit // "unknown"')
              echo "ðŸŽ‰ Bisection complete! Failing commit: $failing_commit"
              break
            fi
            
            # Show restart instructions
            python3 bisect.py show-restart $step_number ${{ inputs.test_job_name }} --platform github --repo-path ${{ inputs.repository }}
            
            commit=$(echo "$step_info_json" | jq -r '.commit')
            
            if [ "${{ inputs.dry_run }}" = "true" ]; then
              # Simulate test result
              if [ $((step_number % 2)) -eq 0 ]; then
                simulated_result="SUCCESS"
              else
                simulated_result="FAILURE"
              fi
              echo "ðŸŽ­ Simulated result: $simulated_result"
              
              python3 bisect.py record $commit $simulated_result --repo-path ${{ inputs.repository }} > /dev/null
            else
              # Execute real job
              session_id=$(echo "$step_info_json" | jq -r '.session_id')
              start_time=$(date +%s)
              
              # Trigger the test workflow
              gh workflow run ${{ inputs.test_job_name }} \
                --field git_sha=$commit \
                --field bisect_session_id=$session_id \
                --field bisect_step=$step_number \
                --field repository=${{ inputs.repository }}
              
              # Wait a moment for the workflow to start
              sleep 10
              
              # Get the latest run ID and wait for completion
              latest_run_id=$(gh run list --workflow=${{ inputs.test_job_name }} --limit=1 --json databaseId --jq '.[0].databaseId')
              
              # Wait for completion
              gh run watch $latest_run_id --exit-status
              
              # Get run results
              run_info=$(gh run view $latest_run_id --json conclusion,url)
              run_status=$(echo "$run_info" | jq -r '.conclusion')
              run_url=$(echo "$run_info" | jq -r '.url')
              
              duration=$(($(date +%s) - start_time))
              
              result="SUCCESS"
              if [ "$run_status" != "success" ]; then
                result="FAILURE"
              fi
              
              # Log the job execution
              python3 bisect.py log-job \
                ${{ inputs.test_job_name }} \
                $result \
                $duration \
                --job-url $run_url \
                --build-number $latest_run_id \
                --repo-path ${{ inputs.repository }} > /dev/null
              
              # Record the test result
              python3 bisect.py record $commit $result --repo-path ${{ inputs.repository }} > /dev/null
            fi
            
            step_number=$((step_number + 1))
            sleep 2
          done
          
          if [ $step_number -gt $max_steps ]; then
            echo "Bisection exceeded maximum steps"
            exit 1
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Generate Final Report
        run: |
          python3 bisect.py final-report --repo-path ${{ inputs.repository }}

      - name: Display Summary
        if: always()
        run: |
          python3 bisect.py summary --repo-path ${{ inputs.repository }}

      - name: Upload Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: bisection-results-${{ github.run_id }}
          path: |
            bisection_state.json
            bisection.log
            restart_instructions.log
            bisection_final_report.txt

      - name: Cleanup
        if: always()
        run: |
          rm -f bisect.py
